# 第二次修复说明

## 问题分析

根据日志和API文档分析，发现了以下关键问题：

### 1. CoinEx 问题
- **现象**：连接后约30秒断开（1006错误）
- **原因**：
  - CoinEx API文档中没有提到心跳机制
  - 之前添加的心跳可能格式不正确或不需要
  - 数据解析逻辑可能有问题，需要添加调试日志

### 2. Crypto.com 问题
- **现象**：连接频繁断开（1000错误），SSL握手错误
- **原因**：
  - **关键发现**：Crypto.com使用**服务器主动心跳机制**
  - 服务器每30秒发送心跳消息，客户端必须在5秒内响应
  - 之前实现的是客户端主动发送心跳，这是错误的
  - 数据解析逻辑需要优化

## 修复内容

### 1. CoinEx 修复 ✅

**修改文件**：`backend/src/main/java/com/experiment/websocket/handler/CoinExHandler.java`

**修复内容**：
1. **移除心跳机制**：根据API文档，CoinEx可能不需要心跳，将`getHeartbeatMessage()`返回`null`
2. **增强调试日志**：
   - 记录所有收到的消息（debug级别）
   - 记录数据保存成功的情况
   - 记录解析过程中的详细信息
3. **优化数据解析**：
   - 添加更详细的错误处理
   - 记录处理状态，便于排查问题

**关键改动**：
```java
@Override
public String getHeartbeatMessage() {
    // CoinEx API文档中没有提到心跳机制，可能不需要
    return null;
}
```

### 2. Crypto.com 修复 ✅

**修改文件**：`backend/src/main/java/com/experiment/websocket/handler/CryptoComHandler.java`

**修复内容**：
1. **修复心跳机制**：
   - **关键修复**：Crypto.com使用服务器主动心跳，客户端必须响应
   - 在`onMessage`中检测服务器发送的心跳消息（`public/heartbeat`）
   - 立即响应心跳（`public/respond-heartbeat`），使用相同的`id`
   - 移除客户端主动发送心跳的逻辑

2. **增强数据解析**：
   - 优化instrument名称提取逻辑（从channel或params中提取）
   - 支持多种数据字段名称（ticker支持`a`, `last`, `k`, `c`等）
   - 添加详细的调试日志

3. **改进错误处理**：
   - 更详细的错误日志
   - 记录数据字段信息，便于排查

**关键改动**：
```java
// 保存client引用以便响应心跳
private ManagedWebSocket client;

@Override
public void onConnected(ManagedWebSocket client) {
    this.client = client;
    // ...
}

// 在onMessage中响应服务器心跳
if (root.has("method") && "public/heartbeat".equals(root.get("method").asText())) {
    Long heartbeatId = root.has("id") ? root.get("id").asLong() : null;
    if (heartbeatId != null && client != null && client.isOpen()) {
        String response = String.format("{\"id\":%d,\"method\":\"public/respond-heartbeat\"}", heartbeatId);
        client.send(response);
    }
    return;
}

@Override
public String getHeartbeatMessage() {
    return null; // 不主动发送心跳，只响应服务器的心跳
}
```

## 预期效果

### CoinEx
- 连接更稳定，减少频繁断开
- 通过调试日志可以查看实际收到的消息和数据
- 如果仍有问题，可以通过日志定位具体原因

### Crypto.com
- **关键修复**：正确响应服务器心跳，连接应该更稳定
- 数据解析更健壮，支持多种字段格式
- 通过调试日志可以查看实际收到的消息和数据

## 测试建议

1. **重启应用**：修复后需要重启后端服务

2. **观察日志**：
   ```bash
   # 查看CoinEx日志
   tail -f backend/logs/backend.log | grep -i coinex
   
   # 查看Crypto.com日志
   tail -f backend/logs/backend.log | grep -i cryptocom
   ```

3. **检查连接稳定性**：
   - 观察是否还有频繁断开的情况
   - 检查连接持续时间是否延长

4. **检查数据**：
   - 刷新前端页面
   - 确认CoinEx和Crypto.com的资金费率和期货价格是否正常显示
   - 如果数据仍为空，查看调试日志中的详细信息

5. **启用调试日志**（如果需要）：
   在`application.yml`中添加：
   ```yaml
   logging:
     level:
       com.experiment.websocket.handler.CoinExHandler: DEBUG
       com.experiment.websocket.handler.CryptoComHandler: DEBUG
   ```

## 注意事项

1. **Crypto.com心跳响应**：这是最关键的修复，如果心跳响应不正确，连接会在5秒内断开

2. **CoinEx心跳**：如果移除心跳后连接仍然不稳定，可能需要：
   - 检查CoinEx API文档，确认是否需要其他保持连接的方式
   - 考虑使用REST API作为备用方案

3. **调试日志**：如果问题仍然存在，启用DEBUG级别的日志可以帮助定位问题

4. **网络环境**：如果仍有连接问题，可能是网络环境或防火墙导致的

## 后续优化建议

如果修复后仍有问题：

1. **CoinEx**：
   - 检查实际收到的消息格式
   - 确认订阅消息格式是否正确
   - 考虑使用REST API定期轮询

2. **Crypto.com**：
   - 确认心跳响应格式是否正确
   - 检查订阅消息格式
   - 验证数据字段名称是否正确

3. **通用优化**：
   - 增加连接状态监控
   - 记录连接时长和断开频率
   - 考虑添加数据缓存机制
