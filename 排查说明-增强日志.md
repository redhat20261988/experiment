# 排查说明 - 增强日志版本

## 问题

CoinEx 和 Crypto.com 的资金费率和期货价格仍然为空，需要深入排查。

## 已完成的改进

### 1. 提升日志级别 ✅

**问题**：之前的调试日志都是DEBUG级别，默认不会输出，无法看到实际发生了什么。

**修复**：
- 将关键的消息接收和数据保存日志提升为 **INFO** 级别
- 这样重启后就能在日志中看到：
  - 实际收到的WebSocket消息
  - 数据解析过程
  - 数据保存成功的情况
  - 错误和警告信息

### 2. CoinEx 增强日志 ✅

**新增的INFO级别日志**：
- `CoinEx received message` - 记录收到的每条消息
- `CoinEx saved funding rate` - 资金费率保存成功
- `CoinEx saved futures price` - 期货价格保存成功
- `CoinEx saved spot price` - 现货价格保存成功
- `CoinEx state.update message processed but no valid data found` - 如果处理了消息但没有找到有效数据

**改进**：
- 当没有找到有效数据时，会记录state_list的大小和第一个market名称，便于排查

### 3. Crypto.com 增强日志 ✅

**新增的INFO级别日志**：
- `Crypto.com received message` - 记录收到的每条消息（心跳消息除外）
- `Crypto.com saved funding rate` - 资金费率保存成功
- `Crypto.com saved futures price` - 期货价格保存成功
- `Crypto.com saved spot price` - 现货价格保存成功

**改进**：
- 当instrument未知时，记录警告和channel信息
- 当没有找到有效数据时，记录数据字段名称和数据内容，便于排查

## 下一步排查步骤

### 1. 重启应用并观察日志

```bash
# 重启后端服务
# 然后观察日志
tail -f backend/logs/backend.log | grep -E "(CoinEx|Crypto\.com|coinex|cryptocom)" -i
```

### 2. 检查关键信息

观察日志中是否出现：

**CoinEx**：
- ✅ `CoinEx WebSocket connected` - 连接成功
- ✅ `CoinEx subscription confirmed` - 订阅确认
- ❓ `CoinEx received message` - 是否收到数据消息
- ❓ `CoinEx saved funding rate` - 是否保存了数据

**Crypto.com**：
- ✅ `Crypto.com WebSocket connected` - 连接成功
- ✅ `Crypto.com subscription confirmed` - 订阅确认
- ❓ `Crypto.com heartbeat responded` - 心跳响应（应该每30秒出现）
- ❓ `Crypto.com received message` - 是否收到数据消息
- ❓ `Crypto.com saved funding rate` - 是否保存了数据

### 3. 可能的问题场景

#### 场景A：没有收到数据消息
**现象**：只有连接和订阅确认，但没有数据消息
**可能原因**：
- WebSocket连接不稳定，在收到数据前就断开了
- 订阅消息格式不正确
- API端点或频道名称错误

**排查**：
- 检查连接是否频繁断开
- 查看订阅确认消息的内容
- 对比API文档确认订阅格式

#### 场景B：收到了消息但解析失败
**现象**：有`received message`但没有`saved`日志
**可能原因**：
- 消息格式与预期不符
- 字段名称不匹配
- 数据为空或格式错误

**排查**：
- 查看日志中的消息内容
- 对比API文档确认字段名称
- 检查数据解析逻辑

#### 场景C：数据保存了但前端显示为空
**现象**：有`saved`日志但前端仍显示"-"
**可能原因**：
- Redis数据格式问题
- 前端API调用问题
- 数据过期被清理

**排查**：
- 检查Redis中的数据
- 查看前端API响应
- 检查数据更新时间

### 4. 检查Redis数据

如果日志显示数据已保存，检查Redis：

```bash
# 检查CoinEx数据
redis-cli HGETALL "funding:coinex:BTCUSDT"
redis-cli HGETALL "futures:coinex:BTCUSDT"
redis-cli HGETALL "spot:coinex:BTCUSDT"

# 检查Crypto.com数据
redis-cli HGETALL "funding:cryptocom:BTCUSDT"
redis-cli HGETALL "futures:cryptocom:BTCUSDT"
redis-cli HGETALL "spot:cryptocom:BTCUSDT"
```

### 5. 检查前端API

如果Redis有数据但前端显示为空：

```bash
# 测试API端点
curl http://localhost:8080/api/market/BTC
```

查看返回的JSON中CoinEx和Crypto.com的数据。

## 预期日志输出示例

### CoinEx 正常情况：
```
INFO - CoinEx WebSocket connected
INFO - CoinEx subscription confirmed: {"id":1,"result":"ok"}
INFO - CoinEx received message - method: state.update, message length: 1234
INFO - CoinEx saved funding rate for BTCUSDT: 0.0001
INFO - CoinEx saved futures price for BTCUSDT: 67234.56
INFO - CoinEx saved spot price for BTCUSDT: 67200.00
```

### Crypto.com 正常情况：
```
INFO - Crypto.com WebSocket connected
INFO - Crypto.com subscription confirmed: {"id":1,"result":"subscribed"}
INFO - Crypto.com heartbeat responded, id: 1234567890
INFO - Crypto.com received message - method: , length: 567
INFO - Crypto.com saved funding rate for BTCUSDT: 0.0001
INFO - Crypto.com saved futures price (mark) for BTCUSDT: 67234.56
INFO - Crypto.com saved spot price for BTCUSDT: 67200.00
```

## 注意事项

1. **日志级别**：现在使用INFO级别，会输出较多日志，生产环境可以考虑调整回DEBUG
2. **性能影响**：INFO级别的日志对性能影响很小，可以持续使用
3. **日志文件大小**：如果日志文件增长过快，考虑使用日志轮转

## 如果问题仍然存在

根据日志输出，我们可以：
1. 确认是否收到了数据消息
2. 查看实际的消息格式
3. 检查数据解析逻辑是否正确
4. 验证数据是否成功保存到Redis

请重启应用后，将日志输出分享给我，我可以进一步分析和修复。
