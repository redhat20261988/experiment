# 交易所资金费率和期货价格为空问题排查报告

## 问题概述
Coinbase、CoinEx、Crypto.com 三个交易所的资金费率和期货价格显示为空（"-"）。

## 问题分析

### 1. Coinbase 交易所

**问题原因：**
- `CoinbaseHandler` 只处理现货价格（BTC-USD, ETH-USD），不处理期货价格和资金费率
- 代码注释明确说明："期货/资金费率需 INTX API（需认证），暂不接入。"
- `CoinbaseIntxHandler` 可以处理期货和资金费率，但需要配置 API Key
- 配置文件中 Coinbase INTX 的配置被注释掉了（`application.yml` 第19-23行）

**代码位置：**
- `backend/src/main/java/com/experiment/websocket/handler/CoinbaseHandler.java` - 只处理现货
- `backend/src/main/java/com/experiment/websocket/handler/CoinbaseIntxHandler.java` - 处理期货和资金费率（需配置）

**解决方案：**
1. 如果需要 Coinbase 的期货和资金费率数据，需要：
   - 在 Coinbase 国际站（INTX）注册并获取 API Key
   - 在 `application.yml` 中配置：
     ```yaml
     coinbase:
       intx:
         api-key: your-api-key
         api-secret: your-api-secret
         passphrase: your-passphrase
     ```
   - 重启应用后，`CoinbaseIntxHandler` 会自动启动并连接

2. 如果不需要 Coinbase 的期货数据，可以保持现状（只显示现货价格）

### 2. CoinEx 交易所

**问题原因：**
- 代码实现完整，订阅了 `state.subscribe` 频道
- 从日志看，WebSocket 连接经常断开（1006 错误）
- 连接不稳定导致数据无法正常接收和保存

**代码位置：**
- `backend/src/main/java/com/experiment/websocket/handler/CoinExHandler.java`

**日志证据：**
```
2026-02-19T21:41:16.825+08:00  WARN ... [coinex] 连接关闭: 1006 - 
2026-02-19T21:42:19.066+08:00  WARN ... [coinex] 连接关闭: 1006 - 
```

**可能原因：**
1. CoinEx WebSocket 服务器端主动断开连接（可能是超时或限制）
2. 网络不稳定
3. 缺少心跳机制保持连接

**解决方案：**
1. 检查 CoinEx WebSocket API 文档，确认是否需要心跳消息
2. 如果 API 支持心跳，在 `CoinExHandler` 中实现 `getHeartbeatMessage()` 方法
3. 增加连接重试机制和错误处理
4. 检查 CoinEx API 是否有连接限制或认证要求

### 3. Crypto.com 交易所

**问题原因：**
- 代码实现完整，订阅了 `funding`、`ticker`、`mark`、`index` 频道
- 从日志看，WebSocket 连接频繁断开（1000 错误）
- 还有 SSL 握手错误（`SSLHandshakeException`）
- 连接不稳定导致数据无法正常接收和保存

**代码位置：**
- `backend/src/main/java/com/experiment/websocket/handler/CryptoComHandler.java`

**日志证据：**
```
2026-02-19T21:44:15.453+08:00  WARN ... [cryptocom] 连接关闭: 1000 - 
2026-02-19T21:57:37.457+08:00 ERROR ... [cryptocom] WebSocket 错误
javax.net.ssl.SSLHandshakeException: Remote host terminated the handshake
```

**可能原因：**
1. SSL/TLS 握手失败
2. Crypto.com WebSocket 服务器端主动断开连接
3. 网络不稳定或防火墙问题
4. API 端点或订阅格式可能有问题

**解决方案：**
1. 检查 Crypto.com WebSocket API 文档，确认：
   - WebSocket URL 是否正确：`wss://stream.crypto.com/exchange/v1/market`
   - 订阅消息格式是否正确
   - 是否需要认证或特殊请求头
2. 检查 SSL/TLS 配置，可能需要更新证书或调整 SSL 设置
3. 增加更详细的错误日志，记录收到的原始消息以便调试
4. 检查 Crypto.com API 是否有连接限制或需要认证

## 建议的修复步骤

### 优先级 1：Coinbase（配置问题）
1. 如果需要期货数据：配置 Coinbase INTX API Key
2. 如果不需要：保持现状，或在前端隐藏 Coinbase 的期货相关列

### 优先级 2：CoinEx 和 Crypto.com（连接稳定性）

**发现的问题：**
- CoinEx 和 Crypto.com 都没有实现心跳机制
- 对比：Bitget 和 MEXC 都实现了心跳机制（`getHeartbeatMessage()`），连接更稳定

**修复建议：**

#### 1. CoinEx - 添加心跳机制
根据 CoinEx API 文档，可能需要实现 ping/pong 机制。建议添加：

```java
@Override
public String getHeartbeatMessage() {
    return "{\"method\":\"server.ping\",\"params\":[],\"id\":0}";
}

@Override
public long getHeartbeatIntervalMs() {
    return 30_000; // 30秒发送一次心跳
}
```

#### 2. Crypto.com - 添加心跳和错误处理
根据 Crypto.com API 文档，可能需要实现心跳。建议：

```java
@Override
public String getHeartbeatMessage() {
    long nonce = System.currentTimeMillis();
    return String.format("{\"id\":%d,\"method\":\"public/heartbeat\",\"nonce\":%d}", nonce, nonce);
}

@Override
public long getHeartbeatIntervalMs() {
    return 20_000; // 20秒发送一次心跳
}
```

#### 3. 增强错误日志
在 `onMessage` 方法中增加更详细的日志：

```java
// CoinEx
catch (Exception e) {
    log.warn("CoinEx parse error: {} - Message: {}", e.getMessage(), message);
}

// Crypto.com  
catch (Exception e) {
    log.warn("Crypto.com parse error: {} - Message: {}", e.getMessage(), message);
}
```

#### 4. 处理订阅确认消息
确保正确处理订阅确认，避免误判为数据消息：

```java
// CoinEx - 在 onMessage 开头添加
if (root.has("id") && root.has("result")) {
    // 订阅确认消息，忽略
    return;
}

// Crypto.com - 已处理，但可以优化
if (root.has("id") && root.has("result") && !root.has("params")) {
    // 订阅确认消息
    return;
}
```

## 临时解决方案

如果暂时无法解决连接问题，可以考虑：
1. 使用 REST API 作为备用方案，定期轮询获取数据
2. 增加数据缓存，在 WebSocket 断开时使用缓存数据
3. 在前端显示连接状态，告知用户数据可能不完整
